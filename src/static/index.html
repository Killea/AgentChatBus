<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AgentChatBus Console</title>
<link rel="icon" type="image/png" href="/static/bus.png" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link
  href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
  rel="stylesheet" />
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Reset & Base
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-base:      #0a0d12;
  --bg-panel:     #0f1318;
  --bg-card:      #151a22;
  --bg-hover:     #1a2030;
  --bg-input:     #111620;
  --border:       #1e2635;
  --border-light: #253040;
  --accent:       #3b82f6;
  --accent-dim:   #1d4ed8;
  --accent-glow:  rgba(59,130,246,.18);
  --green:        #22c55e;
  --amber:        #f59e0b;
  --purple:       #a855f7;
  --red:          #ef4444;
  --text-1:       #e2e8f0;
  --text-2:       #94a3b8;
  --text-3:       #4b5563;
  --radius:       10px;
  --shadow:       0 4px 24px rgba(0,0,0,.5);
}

html, body { height: 100%; overflow: hidden; }

body {
  font-family: 'Inter', system-ui, sans-serif;
  background: var(--bg-base);
  color: var(--text-1);
  display: flex;
  flex-direction: column;
}

body[data-theme="light"] {
  --bg-base:      #f3f6fb;
  --bg-panel:     #ffffff;
  --bg-card:      #f9fbff;
  --bg-hover:     #edf3ff;
  --bg-input:     #ffffff;
  --border:       #d9e2ef;
  --border-light: #c8d4e5;
  --accent:       #2563eb;
  --accent-dim:   #1d4ed8;
  --accent-glow:  rgba(37,99,235,.18);
  --green:        #16a34a;
  --amber:        #d97706;
  --purple:       #7c3aed;
  --red:          #dc2626;
  --text-1:       #0f172a;
  --text-2:       #334155;
  --text-3:       #64748b;
  --shadow:       0 4px 20px rgba(15,23,42,.12);
}

body[data-theme="light"] #topbar .logo {
  background: linear-gradient(135deg, #1d4ed8, #7c3aed);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
}
body[data-theme="light"] .thread-item:hover,
body[data-theme="light"] .thread-item.active {
  background: #e8f0ff;
}
body[data-theme="light"] .badge-discuss {
  background: rgba(37,99,235,.14);
  color: #1d4ed8;
}
body[data-theme="light"] .badge-implement {
  background: rgba(22,163,74,.14);
  color: #15803d;
}
body[data-theme="light"] .badge-review {
  background: rgba(217,119,6,.14);
  color: #b45309;
}
body[data-theme="light"] .badge-done {
  background: rgba(124,58,237,.14);
  color: #6d28d9;
}
body[data-theme="light"] .badge-closed {
  background: rgba(100,116,139,.16);
  color: #475569;
}
body[data-theme="light"] .badge-archived {
  background: rgba(148,163,184,.2);
  color: #475569;
}
body[data-theme="light"] #online-presence {
  background: rgba(22,163,74,.14);
  border-color: rgba(22,163,74,.35);
  color: #166534;
}
body[data-theme="light"] #online-presence:hover {
  background: rgba(22,163,74,.2);
  border-color: rgba(22,163,74,.45);
}
body[data-theme="light"] .msg-sys-event {
  background: rgba(217,119,6,.1);
  border-color: rgba(217,119,6,.24);
  color: #92400e;
}
body[data-theme="light"] .ctx-item:hover {
  background: #e8f0ff;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Top bar
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#topbar {
  height: 52px;
  background: var(--bg-panel);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 20px;
  gap: 12px;
  flex-shrink: 0;
  z-index: 10;
}
#topbar .logo {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-size: 16px;
  font-weight: 700;
  background: linear-gradient(135deg, #3b82f6, #a855f7);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  letter-spacing: -.3px;
}
#topbar .logo img {
  width: 18px;
  height: 18px;
  border-radius: 4px;
  object-fit: cover;
  flex-shrink: 0;
}
#topbar .sep { flex: 1; }
#status-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--green);
  box-shadow: 0 0 8px var(--green);
  animation: pulse-dot 2s infinite;
}
@keyframes pulse-dot {
  0%,100% { opacity: 1; }
  50%      { opacity: .4; }
}
#topbar .status-label { font-size: 12px; color: var(--text-2); }
#btn-new-thread {
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: var(--radius);
  padding: 6px 14px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  display: flex; align-items: center; gap: 6px;
  transition: background .15s, transform .1s;
}
#btn-new-thread:hover { background: #2563eb; }
#btn-new-thread:active { transform: scale(.97); }
#btn-theme-toggle {
  background: transparent;
  color: var(--text-2);
  border: 1px solid var(--border-light);
  border-radius: var(--radius);
  padding: 6px 10px;
  font-size: 12px;
  cursor: pointer;
  transition: background .15s, color .15s;
}
#btn-theme-toggle:hover {
  background: var(--bg-hover);
  color: var(--text-1);
}
#btn-settings {
  background: transparent;
  border: 1px solid var(--border-light);
  border-radius: 8px;
  font-size: 16px;
  width: 34px;
  height: 34px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: var(--text-1);
  margin-left: 8px;
  transition: background 0.15s;
}
#btn-settings:hover {
  background: var(--bg-hover);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Layout: sidebar + main
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#layout {
  display: flex;
  flex: 1;
  min-height: 0;
}

/* â”€â”€ Sidebar â”€â”€ */
#sidebar {
  width: 260px;
  background: var(--bg-panel);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
}
#sidebar-tabs {
  display: flex;
  border-bottom: 1px solid var(--border);
}
.stab {
  flex: 1; padding: 10px; font-size: 12px; font-weight: 600;
  text-align: center; cursor: pointer; color: var(--text-3);
  transition: color .15s, border-color .15s;
  border-bottom: 2px solid transparent;
  letter-spacing: .04em; text-transform: uppercase;
}
.stab.active { color: var(--accent); border-bottom-color: var(--accent); }

#thread-pane { flex: 1; overflow-y: auto; display: block; }

#thread-filter-wrap {
  border-bottom: 1px solid var(--border);
  padding: 8px 10px;
  position: relative;
}
#btn-thread-filter {
  width: 100%;
  background: var(--bg-card);
  color: var(--text-2);
  border: 1px solid var(--border-light);
  border-radius: 8px;
  padding: 6px 10px;
  font-size: 12px;
  text-align: left;
  cursor: pointer;
}
#btn-thread-filter:hover { background: var(--bg-hover); }
#thread-filter-panel {
  display: none;
  position: absolute;
  left: 10px;
  right: 10px;
  top: 44px;
  background: var(--bg-card);
  border: 1px solid var(--border-light);
  border-radius: 10px;
  box-shadow: var(--shadow);
  z-index: 20;
  padding: 8px;
}
#thread-filter-panel.visible { display: block; }
.filter-actions {
  display: flex;
  gap: 8px;
  margin-bottom: 8px;
}
.filter-actions button {
  flex: 1;
  background: var(--bg-hover);
  color: var(--text-2);
  border: 1px solid var(--border-light);
  border-radius: 7px;
  font-size: 11px;
  padding: 5px 6px;
  cursor: pointer;
}
.filter-actions button:hover { background: #233047; }
.filter-row {
  display: flex;
  align-items: center;
  gap: 7px;
  font-size: 12px;
  color: var(--text-1);
  padding: 4px 2px;
}
.filter-row input { accent-color: var(--accent); }

/* Thread list */
.thread-item {
  padding: 12px 16px;
  cursor: pointer;
  border-left: 3px solid transparent;
  transition: background .15s, border-color .15s;
  position: relative;
}
.thread-item:hover { background: var(--bg-hover); }
.thread-item.active {
  background: var(--bg-hover);
  border-left-color: var(--accent);
}
.thread-item .ti-topic {
  font-size: 13px; font-weight: 500;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  color: var(--text-1);
}
.thread-item .ti-meta {
  font-size: 11px; color: var(--text-3); margin-top: 4px;
  display: flex; align-items: center; gap: 6px;
}
.badge {
  display: inline-flex; align-items: center;
  padding: 2px 7px; border-radius: 20px; font-size: 10px; font-weight: 600;
  letter-spacing: .04em; text-transform: uppercase;
}
.badge-discuss   { background: rgba(59,130,246,.15);  color: #60a5fa; }
.badge-implement { background: rgba(34,197,94,.12);   color: #4ade80; }
.badge-review    { background: rgba(245,158,11,.12);  color: #fbbf24; }
.badge-done      { background: rgba(168,85,247,.12);  color: #c084fc; }
.badge-closed    { background: rgba(75,85,99,.15);    color: var(--text-3); }
.badge-archived  { background: rgba(148,163,184,.16); color: #94a3b8; }

/* Agent list */
.agent-item {
  padding: 10px 16px;
  display: flex; align-items: center; gap: 10px;
  border-bottom: 1px solid var(--border);
}
.agent-avatar {
  width: 32px; height: 32px; border-radius: 8px;
  background: linear-gradient(135deg, #1d4ed8, #7c3aed);
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 700; color: #fff; flex-shrink: 0;
}
.agent-avatar-interactive { cursor: pointer; }
.agent-name { font-size: 13px; font-weight: 500; }
.agent-desc { font-size: 11px; color: var(--text-3); margin-top: 2px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }
.online-dot {
  width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; margin-left: auto;
}
.online-dot.on  { background: var(--green); box-shadow: 0 0 6px var(--green); }
.online-dot.off { background: var(--text-3); }

/* â”€â”€ Main area â”€â”€ */
#main {
  flex: 1; display: flex; flex-direction: column; min-width: 0; min-height: 0;
}

/* Thread header */
#thread-header {
  padding: 0 20px;
  height: 52px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 12px;
  flex-shrink: 0;
}
#thread-header h2 { font-size: 15px; font-weight: 600; flex: 1; min-width: 0;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
#online-presence {
  margin-left: auto;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 56px;
  height: 28px;
  padding: 0 10px;
  border-radius: 999px;
  border: 1px solid var(--border-light);
  background: rgba(34,197,94,.12);
  color: #86efac;
  font-size: 12px;
  font-weight: 600;
  letter-spacing: .01em;
  cursor: default;
  transition: background .15s, border-color .15s;
}
#online-presence:hover {
  background: rgba(34,197,94,.18);
  border-color: rgba(34,197,94,.45);
}
#online-count {
  white-space: nowrap;
}

/* Messages */
#messages {
  flex: 1; overflow-y: auto; padding: 20px;
  display: flex; flex-direction: column; gap: 14px;
  min-height: 0;
}
#messages.loading-history .msg-row,
#messages.loading-history .msg-sys-event {
  animation: none !important;
}
#messages::-webkit-scrollbar { width: 16px; }
#messages::-webkit-scrollbar-track { background: transparent; }
#messages::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 4px; }
#messages > acb-empty-state {
  display: flex;
  flex: 1;
  min-height: 100%;
}

/* â”€â”€ Message rows (author-based coloring) â”€â”€ */
.msg-row {
  display: flex; align-items: flex-start; gap: 10px; max-width: 82%;
  animation: bubble-in .2s ease;
}
.msg-row-left  { align-self: flex-start; }
.msg-row-right { align-self: flex-end; flex-direction: row-reverse; }

@keyframes bubble-in {
  from { opacity: 0; transform: translateY(6px) scale(.98); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}

.msg-avatar {
  width: 32px; height: 32px; border-radius: 9px; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 11px; font-weight: 700; letter-spacing: .02em;
  margin-top: 2px;
}
.msg-avatar-interactive { cursor: pointer; }

.msg-col { display: flex; flex-direction: column; gap: 4px; min-width: 0; }
.msg-row-right .msg-col { align-items: flex-end; }

.msg-header {
  display: flex; align-items: baseline; gap: 8px;
  font-size: 11px;
}
.msg-row-right .msg-header { flex-direction: row-reverse; }
.msg-author-label { font-weight: 600; }
.msg-time-label   { color: var(--text-3); }

.bubble-v2 {
  padding: 10px 14px;
  border-radius: 12px;
  font-size: 13.5px; line-height: 1.6;
  word-break: break-word;
  background: var(--bg-card);
  border: 1px solid var(--border-light);
  border-left-width: 3px;
  max-width: 100%;
}
.msg-row-right .bubble-v2 {
  border-left-width: 1px;
  border-right-width: 3px;
}

.bubble-v2 pre {
  margin: 8px 0;
  padding: 10px 12px;
  background: var(--bg-input);
  border: 1px solid var(--border-light);
  border-radius: 10px;
  overflow: auto;
}
.code-block {
  position: relative;
}
.code-block pre {
  padding-top: 34px;
}
.code-copy {
  position: absolute;
  top: 6px;
  right: 6px;
  font-size: 11px;
  padding: 4px 8px;
  border-radius: 8px;
  border: 1px solid var(--border-light);
  background: var(--bg-card);
  color: var(--text-2);
  cursor: pointer;
}
.code-copy:active {
  transform: translateY(1px);
}
.code-copy:disabled {
  cursor: default;
  opacity: .8;
}
.bubble-v2 pre code {
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 12.5px;
  line-height: 1.5;
  white-space: pre;
}
.bubble-v2 code.inline-code {
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 12.5px;
  background: var(--bg-input);
  border: 1px solid var(--border-light);
  border-radius: 8px;
  padding: 1px 6px;
}

/* System event row (centered) */
.msg-sys-event {
  align-self: center; max-width: 80%;
  padding: 6px 14px;
  background: rgba(245,158,11,.07);
  border: 1px solid rgba(245,158,11,.18);
  border-radius: 20px;
  font-size: 11.5px; font-style: italic; color: #fbbf24;
  text-align: center;
  animation: bubble-in .2s ease;
}

.bubble-meta { font-size: 10px; color: var(--text-3); margin: 0 4px; }

.typing-bubble {
  display: flex; align-items: center; gap: 4px;
  padding: 10px 16px;
  background: var(--bg-card); border: 1px solid var(--border-light);
  border-radius: 14px 14px 14px 4px;
  max-width: 80px;
}
.typing-bubble span {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--text-3); display: block;
  animation: bouncing .9s infinite;
}
.typing-bubble span:nth-child(2) { animation-delay: .15s; }
.typing-bubble span:nth-child(3) { animation-delay: .3s; }
@keyframes bouncing {
  0%,60%,100% { transform: translateY(0); }
  30%         { transform: translateY(-5px); background: var(--accent); }
}

/* Empty state */
#empty-state {
  flex: 1; display: flex; flex-direction: column; align-items: center;
  justify-content: center; color: var(--text-3); gap: 12px;
}
#empty-state .es-icon { font-size: 48px; opacity: .4; }
#empty-state .es-title { font-size: 16px; font-weight: 600; color: var(--text-2); }
#empty-state .es-sub { font-size: 13px; }

/* Compose */
#compose {
  padding: 14px 20px;
  border-top: 1px solid var(--border);
  display: none; gap: 10px; align-items: flex-end;
  background: var(--bg-panel);
}
#compose.visible { display: flex; }
#compose-author {
  background: var(--bg-input); border: 1px solid var(--border-light);
  color: var(--text-2); border-radius: 8px;
  padding: 8px 10px; font-size: 12px; font-family: inherit;
  width: 100px; flex-shrink: 0;
}
#compose-author:focus { outline: none; border-color: var(--accent); }
#compose-input {
  flex: 1; background: var(--bg-input); border: 1px solid var(--border-light);
  color: var(--text-1); border-radius: 10px; padding: 10px 14px;
  font-size: 13.5px; resize: none; min-height: 42px; max-height: 140px;
  font-family: inherit; line-height: 1.5;
  transition: border-color .15s;
}
#compose-input:focus { outline: none; border-color: var(--accent); }
#compose-input::placeholder { color: var(--text-3); }
#btn-send {
  background: var(--accent); color: #fff; border: none; border-radius: 10px;
  width: 40px; height: 40px; cursor: pointer; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; transition: background .15s, transform .1s;
}
#btn-send:hover { background: #2563eb; }
#btn-send:active { transform: scale(.93); }

/** Agent Status Bar **/
#agent-status-bar {
  display: flex;
  background: var(--bg-base);
  border-top: 1px solid var(--border-light);
  padding: 8px 12px;
  height: 56px;
  overflow-x: auto;
  overflow-y: hidden;
  gap: 10px;
  font-size: 12px;
}
#agent-status-list {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: nowrap;
}
.agent-status-item {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 12px;
  background: var(--bg-input);
  border: 1px solid var(--border-light);
  border-radius: 8px;
  white-space: nowrap;
  flex-shrink: 0;
  font-size: 12px;
  color: var(--text-1);
}
.agent-status-emoji {
  font-size: 16px;
  width: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.agent-status-text {
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.agent-alias {
  font-weight: 500;
  color: var(--text-1);
}
.agent-state {
  font-size: 11px;
  color: var(--text-2);
}
.agent-status-text-compact {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-2);
  min-width: 16px;
  text-align: center;
}

#agent-status-info {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  cursor: help;
  padding: 4px 8px;
  border-radius: 4px;
  transition: background-color 0.2s;
  flex-shrink: 0;
  position: relative;
}
#agent-status-info:hover {
  background-color: var(--bg-input);
}

.acb-tooltip-info .state-item {
  margin-bottom: 8px;
}
.acb-tooltip-info .state-item:last-child {
  margin-bottom: 0;
}
.acb-tooltip-info .state-emoji {
  font-weight: bold;
  margin-right: 6px;
}
.acb-tooltip-info strong {
  color: var(--text-1);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Modal
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,.7);
  display: none; align-items: center; justify-content: center;
  z-index: 100; animation: fade-in .15s ease;
}
#modal-overlay.visible { display: flex; }
@keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
#modal {
  background: var(--bg-card); border: 1px solid var(--border-light);
  border-radius: 14px; padding: 28px; width: 440px; max-width: 90vw;
  box-shadow: var(--shadow);
  animation: modal-in .2s ease;
}
@keyframes modal-in {
  from { opacity: 0; transform: scale(.95) translateY(-10px); }
  to   { opacity: 1; transform: scale(1) translateY(0); }
}
#modal h3 { font-size: 16px; font-weight: 600; margin-bottom: 18px; }
#modal-topic {
  width: 100%; background: var(--bg-input); border: 1px solid var(--border-light);
  color: var(--text-1); border-radius: 10px; padding: 10px 14px;
  font-size: 14px; font-family: inherit; margin-bottom: 16px;
}
#modal-topic:focus { outline: none; border-color: var(--accent); }
.modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
.btn-secondary {
  background: var(--bg-hover); color: var(--text-2); border: 1px solid var(--border-light);
  border-radius: 8px; padding: 8px 18px; font-size: 13px;
  cursor: pointer; font-family: inherit; transition: background .15s;
}
.btn-secondary:hover { background: var(--border-light); }
.btn-primary {
  background: var(--accent); color: #fff; border: none;
  border-radius: 8px; padding: 8px 18px; font-size: 13px;
  cursor: pointer; font-family: inherit; transition: background .15s;
}
.btn-primary:hover { background: #2563eb; }

/* Thread context menu */
#thread-context-menu {
  position: fixed;
  min-width: 150px;
  background: var(--bg-card);
  border: 1px solid var(--border-light);
  border-radius: 10px;
  box-shadow: var(--shadow);
  padding: 6px;
  z-index: 1200;
  display: none;
}
#thread-context-menu.visible { display: block; }
.ctx-item {
  width: 100%;
  text-align: left;
  background: transparent;
  border: none;
  color: var(--text-1);
  border-radius: 8px;
  padding: 8px 10px;
  font-size: 12px;
  cursor: pointer;
}
.ctx-item:hover { background: var(--bg-hover); }
.ctx-item:disabled {
  color: var(--text-3);
  cursor: not-allowed;
}

#footer-link {
  display: inline-flex;
  align-items: center;
  font-size: 11px;
  color: var(--text-3);
  opacity: .72;
  margin-left: 2px;
}
#footer-link a {
  color: inherit;
  text-decoration: none;
}
#footer-link a:hover {
  color: var(--text-2);
  text-decoration: underline;
}

/* Scrollbar */
#thread-pane::-webkit-scrollbar { width: 16px; }
#thread-pane::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 4px; }

/* â”€â”€ Agent tooltip (custom, copy-enabled) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.acb-tooltip-agent {
  width: min(380px, calc(100vw - 24px));
  padding: 10px;
}
.agent-tip-title {
  font-size: 12px;
  font-weight: 700;
  color: var(--text-1);
  margin-bottom: 8px;
}
.agent-tip-meta {
  font-size: 11px;
  color: var(--text-2);
  margin-bottom: 8px;
  line-height: 1.5;
}
.agent-tip-meta code {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--text-1);
}
.agent-tip-prompt {
  margin: 0;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--bg-input);
  color: var(--text-1);
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  line-height: 1.45;
  padding: 8px;
  max-height: 180px;
  overflow: auto;
  white-space: pre-wrap;
  word-break: break-word;
}
.agent-tip-actions {
  display: flex;
  gap: 8px;
  margin-top: 8px;
}
.agent-tip-actions button {
  flex: 1;
  border: 1px solid var(--border-light);
  background: var(--bg-hover);
  color: var(--text-1);
  border-radius: 8px;
  font-size: 11px;
  font-weight: 600;
  padding: 6px 8px;
  cursor: pointer;
}
.agent-tip-actions button:hover { border-color: var(--accent); }
</style>
</head>
<body>

<!-- â”€â”€ Top bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="topbar">
  <div class="logo"><img src="/static/bus.png" alt="Bus" />AgentChatBus</div>
  <div id="footer-link">
    <a href="https://github.com/Killea/AgentChatBus" target="_blank" rel="noopener noreferrer">GitHub Â· AgentChatBus</a>
  </div>
  <div class="sep"></div>
  <div id="status-dot"></div>
  <div class="status-label" id="status-label">Connected</div>
  <acb-icon-button button-id="btn-theme-toggle" label="Light" action="toggleTheme"></acb-icon-button>
  <button id="btn-new-thread" onclick="openModal()">ï¼‹ New Thread</button>
  <acb-icon-button button-id="btn-settings" label="âš™ï¸" action="openSettingsModal" title="MCP Server Settings" aria-label="MCP Server Settings"></acb-icon-button>
</div>

<!-- â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="layout">

  <!-- Sidebar -->
  <div id="sidebar">
    <div id="sidebar-tabs">
      <div class="stab active" id="tab-threads" onclick="switchTab('threads')">Threads</div>
    </div>
    <acb-thread-filter-shell></acb-thread-filter-shell>
    <div id="thread-pane" class="visible"></div>
  </div>

  <!-- Main -->
  <div id="main">
    <acb-thread-header></acb-thread-header>

    <div id="messages">
      <acb-empty-state></acb-empty-state>
        </div>
        
        <acb-compose-shell></acb-compose-shell>
        <!-- Agent Status Bar -->
        <acb-agent-status-shell></acb-agent-status-shell>
        </div>
        </div>

<acb-thread-context-menu></acb-thread-context-menu>

<acb-modal-shell></acb-modal-shell>

<script src="/static/js/shared-api.js"></script>
<script src="/static/js/shared-theme.js"></script>
<script src="/static/js/shared-utils.js"></script>
<script src="/static/js/shared-message-renderer.js"></script>
<script src="/static/js/shared-sse.js"></script>
<script src="/static/js/shared-modals.js"></script>
<script src="/static/js/components/acb-modal-shell.js"></script>
<script src="/static/js/components/acb-empty-state.js"></script>
<script src="/static/js/components/acb-icon-button.js"></script>
<script src="/static/js/components/acb-filter-actions.js"></script>
<script src="/static/js/components/acb-filter-row.js"></script>
<script src="/static/js/components/acb-thread-filter-shell.js"></script>
<script src="/static/js/components/acb-thread-context-menu.js"></script>
<script src="/static/js/components/acb-thread-header.js"></script>
<script src="/static/js/components/acb-thread-item.js"></script>
<script src="/static/js/components/acb-compose-shell.js"></script>
<script src="/static/js/components/acb-agent-status-shell.js"></script>
<script src="/static/js/shared-threads.js"></script>
<script src="/static/js/shared-agent-status.js"></script>
<script src="/static/js/components/acb-agent-status-item.js"></script>
<script src="/static/js/shared-agents.js"></script>
<script src="/static/js/shared-chat.js"></script>
<script src="/static/js/shared-tooltip.js"></script>
<script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // State
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let activeThreadId = null;
    let activeThreadStatus = 'discuss';
  let lastSeq = 0;
    let typingTimers = {};   // agent_id -> timer
    let isConnected = false;
    let contextMenuThread = null;
    const onlineAgentKeys = new Set();
    const onlineAgentLabelsByKey = new Map();
    const activeThreadLastSeenMs = new Map();
    const activeThreadLabelsByKey = new Map();
    const THREAD_ACTIVITY_WINDOW_MS = 120000;
    const ALL_THREAD_STATUSES = ['discuss', 'implement', 'review', 'done', 'closed', 'archived'];
    const NORMAL_THREAD_STATUSES = ['discuss', 'implement', 'review', 'done', 'closed'];
    let selectedThreadStatuses = new Set(NORMAL_THREAD_STATUSES);
    let agentTooltipHideTimer = null;
    let activeAgentTooltipTarget = null;
    let currentAgents = []; // Cache of all agents for tooltip lookups

    const EMPTY_STATE_TEMPLATE = '<acb-empty-state></acb-empty-state>';

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Bootstrap
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    (async function init() {
      window.AcbTooltip.init();
      applySavedTheme();
      await refreshThreads();
      await refreshAgents();
      await updateStatusBar();
      updateOnlinePresence();
      startSSE();
      setInterval(refreshAgents, 12000);
      setInterval(updateStatusBar, 5000);  // Update status bar every 5 seconds

      const tip = window.AcbTooltip.getTooltipElement();
      if (tip) {
        tip.addEventListener('mouseenter', () => clearAgentTooltipHideTimer());
        tip.addEventListener('mouseleave', () => scheduleAgentTooltipHide());
        tip.addEventListener('click', async (e) => {
          e.stopPropagation();
          const btn = e.target.closest('button[data-copy]');
          if (!btn) return;
          // Don't allow copy if button is disabled
          if (btn.disabled) {
            const old = btn.textContent;
            btn.textContent = 'Select a thread first';
            setTimeout(() => { btn.textContent = old; }, 1200);
            return;
          }
          const value = btn.getAttribute('data-copy-value') || '';
          const ok = await copyTextWithFallback(value);
          const old = btn.textContent;
          btn.textContent = ok ? 'Copied' : 'Copy failed';
          setTimeout(() => { btn.textContent = old; }, 1200);
        });
      }
    })();

    document.addEventListener('click', () => {
      hideThreadContextMenu();
      hideThreadFilterPanel();
      hideAgentTooltip();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') hideThreadContextMenu();
    });
    window.addEventListener('resize', () => {
      hideThreadContextMenu();
      hideAgentTooltip();
    });

    (function setupUnifiedInfoTooltip() {
      const infoEl = document.getElementById('agent-status-info');
      if (!infoEl) return;

      const tooltipHtml = `
        <div style="padding:8px 12px;min-width:260px;">
          <div style="font-size:12px;color:var(--text-2);margin-bottom:6px;">Status Legend:</div>
          <div class="state-item"><span class="state-emoji">ğŸŸ¢</span> <strong>Active:</strong> Activity within 30s</div>
          <div class="state-item"><span class="state-emoji">ğŸŒ™</span> <strong>Idle:</strong> Activity within 5m</div>
          <div class="state-item"><span class="state-emoji">â³</span> <strong>Waiting:</strong> Waiting for response (&lt;60s)</div>
          <div class="state-item"><span class="state-emoji">âš«</span> <strong>Offline:</strong> No recent activity</div>
        </div>
      `;

      infoEl.addEventListener('mouseenter', () => {
        window.AcbTooltip.showRich(infoEl, tooltipHtml, {
          interactive: false,
          maxWidth: '340px',
          className: 'acb-tooltip-info',
        });
      });
      infoEl.addEventListener('mouseleave', () => window.AcbTooltip.scheduleHide(120));
    })();

    function getResumePromptForAgent(agentId, displayName, token) {
      const threadName = document.getElementById('thread-title')?.textContent?.trim() || '(current thread)';
      const tokenLine = token ? `Token: ${token}\n` : '';
      return `@${displayName}
Please resume this agent session with saved credentials.
1) Call agent_resume(agent_id, token) with your credentials.
2) If resume fails â†’ check token validity and retry.
3) On success â†’ post confirmation message.
4) Begin msg_wait loop to listen for incoming messages.

Agent ID: ${agentId}
${tokenLine}Thread: ${threadName}

Note: Thread name is the topic label. Thread ID is the unique identifier.`;
    }

    async function copyTextWithFallback(text) {
      return window.AcbUtils.copyTextWithFallback(text);
    }

    function clearAgentTooltipHideTimer() {
      if (agentTooltipHideTimer) {
        clearTimeout(agentTooltipHideTimer);
        agentTooltipHideTimer = null;
      }
      window.AcbTooltip.clearHideTimer();
    }

    function scheduleAgentTooltipHide(delay = 120) {
      clearAgentTooltipHideTimer();
      agentTooltipHideTimer = setTimeout(() => hideAgentTooltip(), delay);
    }

    function hideAgentTooltip() {
      clearAgentTooltipHideTimer();
      window.AcbTooltip.hideTooltip();
      activeAgentTooltipTarget = null;
    }

    function showAgentTooltip(anchorEl, agent) {
      if (!anchorEl || !agent) return;
      clearAgentTooltipHideTimer();
      const alias = String(agent.display_name ?? agent.name ?? 'Unknown').trim() || 'Unknown';
      const agentId = String(agent.id ?? agent.agent_id ?? '').trim();
      const ide = String(agent.ide ?? 'Unknown').trim() || 'Unknown';
      const model = String(agent.model ?? 'Unknown').trim() || 'Unknown';
      const token = String(agent.token ?? '').trim();
      const prompt = getResumePromptForAgent(agentId, alias, token);
      
      // Disable resume button if no thread is selected
      const resumeButtonState = activeThreadId ? '' : 'disabled';
      const resumeButtonStyle = activeThreadId ? '' : 'style="opacity:0.5;cursor:not-allowed;"';

      const html = `
        <div class="agent-tip-title">Agent Quick Prompt</div>
        <div class="agent-tip-meta">Alias: <code>${esc(alias)}</code><br/>Agent ID: <code>${esc(agentId || '(unknown)')}</code><br/>IDE: <code>${esc(ide)}</code><br/>Model: <code>${esc(model)}</code></div>
        <pre class="agent-tip-prompt">${esc(prompt)}</pre>
        <div class="agent-tip-actions">
          <button type="button" data-copy="agent-id" data-copy-value="${esc(agentId)}">Copy Agent ID</button>
          <button type="button" data-copy="resume" data-copy-value="${esc(prompt)}" ${resumeButtonState} ${resumeButtonStyle} title="${activeThreadId ? '' : 'Select a thread first'}">Copy Resume Prompt</button>
        </div>`;

      window.AcbTooltip.showRich(anchorEl, html, {
        interactive: true,
        width: 'min(380px, calc(100vw - 24px))',
        maxWidth: '380px',
        className: 'acb-tooltip-agent',
      });
      activeAgentTooltipTarget = anchorEl;
    }

    function bindAgentTooltipEvents(avatarEl, agent) {
      if (!avatarEl) return;
      avatarEl.addEventListener('mouseenter', () => showAgentTooltip(avatarEl, agent));
      avatarEl.addEventListener('mouseleave', () => scheduleAgentTooltipHide());
      avatarEl.addEventListener('click', (e) => {
        e.stopPropagation();
        showAgentTooltip(avatarEl, agent);
      });
    }

    function applySavedTheme() {
      return window.AcbTheme.applySavedTheme();
    }

    function setTheme(theme) {
      return window.AcbTheme.setTheme(theme);
    }

    function toggleTheme() {
      return window.AcbTheme.toggleTheme();
    }

    function updateOnlinePresence() {
      return window.AcbAgents.updateOnlinePresence({
        onlineAgentKeys,
        onlineAgentLabelsByKey,
        activeThreadLastSeenMs,
        activeThreadLabelsByKey,
        threadActivityWindowMs: THREAD_ACTIVITY_WINDOW_MS,
        activeThreadId,
      });
    }

    function getAgentDisplayName(msg) {
      return window.AcbAgents.getAgentDisplayName(msg);
    }

    function getAgentPresenceKey(msg) {
      return window.AcbAgents.getAgentPresenceKey(msg);
    }

    function recordThreadAgentActivity(key, label, createdAtIso) {
      return window.AcbAgents.recordThreadAgentActivity({
        key,
        label,
        createdAtIso,
        activeThreadLastSeenMs,
        activeThreadLabelsByKey,
      });
    }

    function rebuildActiveThreadParticipants(messages) {
      return window.AcbAgents.rebuildActiveThreadParticipants({
        messages,
        getAgentPresenceKey,
        getAgentDisplayName,
        recordThreadAgentActivity,
        activeThreadLastSeenMs,
        activeThreadLabelsByKey,
      });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SSE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function startSSE() {
      return window.AcbSSE.startSSE({
        getActiveThreadId: () => activeThreadId,
        onMsgNew: async () => loadNewMessages(),
        onThreadEvent: async () => refreshThreads(),
        onAgentPresence: async () => refreshAgents(),
        onTyping: (agentId, isTyping) => {
          if (isTyping) showTyping(agentId);
          else hideTyping(agentId);
        },
        setConnected,
      });
  }

    function setConnected(v) {
      isConnected = v;
      return window.AcbSSE.setConnectedUI(v);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // API
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function api(path, opts = {}) {
      return window.AcbApi.api(path, opts);
  }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Threads
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function refreshThreads() {
    return window.AcbThreads.refreshThreads({
      api,
      getSelectedStatuses: () => selectedThreadStatuses,
      getActiveThreadId: () => activeThreadId,
      resetThreadSelection,
      onSelectThread: selectThread,
      onOpenContextMenu: openThreadContextMenu,
      esc,
      timeAgo,
      updateThreadFilterButton,
    });
  }

  function toggleThreadFilterPanel(event) {
    return window.AcbThreads.toggleThreadFilterPanel(event);
  }

  function hideThreadFilterPanel() {
    return window.AcbThreads.hideThreadFilterPanel();
  }

  function selectedStatusListFromUI() {
    return window.AcbThreads.selectedStatusListFromUI();
  }

  function onThreadFilterChange() {
    const selected = selectedStatusListFromUI();
    if (!selected.length) {
      document.querySelectorAll('#thread-filter-panel input[data-status]').forEach((cb) => {
        const status = cb.getAttribute('data-status');
        cb.checked = NORMAL_THREAD_STATUSES.includes(status);
      });
      selectedThreadStatuses = new Set(NORMAL_THREAD_STATUSES);
    } else {
      selectedThreadStatuses = new Set(selected);
    }
    refreshThreads();
  }

  function selectAllThreadStatuses() {
    document.querySelectorAll('#thread-filter-panel input[data-status]').forEach(cb => cb.checked = true);
    onThreadFilterChange();
  }

  function selectNormalThreadStatuses() {
    document.querySelectorAll('#thread-filter-panel input[data-status]').forEach((cb) => {
      const status = cb.getAttribute('data-status');
      cb.checked = NORMAL_THREAD_STATUSES.includes(status);
    });
    onThreadFilterChange();
  }

  function updateThreadFilterButton() {
    return window.AcbThreads.updateThreadFilterButton(
      ALL_THREAD_STATUSES,
      NORMAL_THREAD_STATUSES,
      selectedThreadStatuses
    );
  }

  async function selectThread(id, topic, status) {
    return window.AcbChat.selectThread({
      id,
      topic,
      status,
      setActiveThread: (threadId, threadStatus) => {
        activeThreadId = threadId;
        activeThreadStatus = threadStatus;
      },
      clearThreadParticipants: () => activeThreadLastSeenMs.clear(),
      api,
      rebuildActiveThreadParticipants,
      appendBubble,
      updateOnlinePresence,
      updateStatusBar,
      setLastSeq: (next) => {
        lastSeq = typeof next === 'function' ? next(lastSeq) : next;
      },
      scrollBottom,
    });
  }

  async function loadNewMessages() {
    return window.AcbChat.loadNewMessages({
      getActiveThreadId: () => activeThreadId,
      getLastSeq: () => lastSeq,
      api,
      getAgentPresenceKey,
      getAgentDisplayName,
      recordThreadAgentActivity,
      appendBubble,
      updateOnlinePresence,
      updateStatusBar,
      setLastSeq: (next) => {
        lastSeq = typeof next === 'function' ? next(lastSeq) : next;
      },
      scrollBottom,
    });
  }

    async function closeThread(threadId = activeThreadId) {
    return window.AcbThreads.closeThread({
      threadId,
      api,
      refreshThreads,
    });
  }

  function openThreadContextMenu(event, thread) {
    contextMenuThread = window.AcbThreads.openThreadContextMenu(event, thread);
  }

  function hideThreadContextMenu() {
    contextMenuThread = window.AcbThreads.hideThreadContextMenu();
  }

  async function archiveThreadFromMenu() {
    return window.AcbThreads.archiveThreadFromMenu({
      getContextMenuThread: () => contextMenuThread,
      hideThreadContextMenu,
      api,
      getActiveThreadId: () => activeThreadId,
      resetThreadSelection,
      refreshThreads,
    });
  }

  async function unarchiveThreadFromMenu() {
    return window.AcbThreads.unarchiveThreadFromMenu({
      getContextMenuThread: () => contextMenuThread,
      hideThreadContextMenu,
      api,
      getActiveThreadId: () => activeThreadId,
      resetThreadSelection,
      refreshThreads,
    });
  }

  async function closeThreadFromMenu() {
    return window.AcbThreads.closeThreadFromMenu({
      getContextMenuThread: () => contextMenuThread,
      hideThreadContextMenu,
      closeThread,
    });
  }

  function resetThreadSelection() {
    activeThreadId = null;
    activeThreadStatus = 'discuss';
    lastSeq = 0;
    activeThreadLastSeenMs.clear();

    document.querySelectorAll('.thread-item').forEach(el => el.classList.remove('active'));
    document.getElementById('thread-header').style.display = 'none';
    document.getElementById('compose').classList.remove('visible');
    document.getElementById('messages').innerHTML = EMPTY_STATE_TEMPLATE;
    updateOnlinePresence();
  }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Messages
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // â”€â”€ Color palette: 12 distinct, accessible hues â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const AUTHOR_PALETTE = [
    '#60a5fa', // blue
    '#34d399', // emerald
    '#f472b6', // pink
    '#fb923c', // orange
    '#a78bfa', // purple
    '#22d3ee', // cyan
    '#facc15', // yellow
    '#f87171', // red
    '#4ade80', // green
    '#38bdf8', // sky
    '#e879f9', // fuchsia
    '#a3e635', // lime
  ];
  const HUMAN_COLOR = '#fb923c'; // warm orange â€” always human
  const SYSTEM_COLOR = '#fbbf24'; // amber  â€” system events

  // Cache so the same author always gets the same color in a session
  const _colorCache = {};

  function authorColor(author) {
    if (author === 'human') return HUMAN_COLOR;
    if (author === 'system') return SYSTEM_COLOR;
    if (_colorCache[author]) return _colorCache[author];
    // Stable hash â†’ palette index
    let h = 0;
    for (let i = 0; i < author.length; i++) h = (Math.imul(31, h) + author.charCodeAt(i)) | 0;
    const color = AUTHOR_PALETTE[Math.abs(h) % AUTHOR_PALETTE.length];
    _colorCache[author] = color;
    return color;
  }

  function fmtTime(iso) {
    return window.AcbUtils.fmtTime(iso);
  }

  function normalizeMessageText(raw) {
    return window.AcbMessageRenderer.normalizeMessageText(raw);
  }

  function tokenizeMessage(rawText) {
    return window.AcbMessageRenderer.tokenizeMessage(rawText);
  }

  function parseInlineCodeSegments(line) {
    return window.AcbMessageRenderer.parseInlineCodeSegments(line);
  }

  function renderTextWithInlineCode(containerEl, text) {
    return window.AcbMessageRenderer.renderTextWithInlineCode(containerEl, text);
  }

  function renderMessageContent(containerEl, rawText) {
    return window.AcbMessageRenderer.renderMessageContent(containerEl, rawText);
  }

    function appendBubble(m) {
      const box = document.getElementById('messages');

      // â”€â”€ System event (centered pill) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      if (m.role === 'system' && m.author === 'system') {
        const pill = document.createElement('div');
        pill.className = 'msg-sys-event';
        pill.textContent = m.content;
        box.appendChild(pill);
        return;
      }

      const authorLabel = String(m.author_name ?? m.author ?? '').trim() || 'unknown';
      const isSystem = String(m.role ?? '').toLowerCase() === 'system' || authorLabel.toLowerCase() === 'system';
      const isHuman = authorLabel.toLowerCase() === 'human';
      const authorKey = isHuman ? 'human' : (isSystem ? 'system' : String(m.author_id ?? authorLabel));
      const color = authorColor(authorKey);
      let initials = authorLabel.slice(0, 2).toUpperCase();
      if (!isHuman && !isSystem) {
        const base = authorLabel.split('(')[0].trim().toUpperCase();
        initials = base.substring(0, 3);
      }
      const bgAlpha = `${color}22`;  // ~13% alpha tint for avatar bg

      const row = document.createElement('div');
      row.className = `msg-row ${isHuman ? 'msg-row-right' : 'msg-row-left'}`;
      row.setAttribute('data-author-id', String(m.author_id ?? authorLabel));
      row.setAttribute('data-seq', String(m.seq));

      row.innerHTML = `
        <div class="msg-avatar" style="background:${bgAlpha};color:${color};border:1px solid ${color}44">${initials}</div>
        <div class="msg-col">
          <div class="msg-header">
            <span class="msg-author-label" style="color:${color}">${esc(authorLabel)}</span>
            <span class="msg-time-label">seq ${m.seq} Â· ${fmtTime(m.created_at)}</span>
          </div>
          <div class="bubble-v2" style="border-color:${color}55;${isHuman ? 'border-right-color' : 'border-left-color'}:${color}"></div>
        </div>`;

      const bubbleEl = row.querySelector('.bubble-v2');
      if (bubbleEl) renderMessageContent(bubbleEl, m.content);

      if (!isHuman && !isSystem) {
        const avatarEl = row.querySelector('.msg-avatar');
        if (avatarEl) {
          avatarEl.classList.add('msg-avatar-interactive');
          // Get full agent details from current agents list
          const authorId = String(m.author_id ?? authorLabel);
          const agentData = currentAgents?.find(a => a.id === authorId) || {
            id: authorId,
            agent_id: authorId,
            name: authorLabel,
            display_name: authorLabel,
            ide: 'Unknown',
            model: 'Unknown',
            token: ''
          };
          bindAgentTooltipEvents(avatarEl, agentData);
        }
      }

      box.appendChild(row);
    }

      // â”€â”€ Typing indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showTyping(agentId) {
      const box = document.getElementById('messages');
      let el = document.getElementById(`typing-${agentId}`);
      if (!el) {
        const color = authorColor(agentId);
        const base = agentId.split('(')[0].trim().toUpperCase();
        const initials = base.substring(0, 3);
        const row = document.createElement('div');
        row.className = 'msg-row msg-row-left';
        row.id = `typing-${agentId}`;
        row.innerHTML = `
          <div class="msg-avatar" style="background:${color}22;color:${color};border:1px solid ${color}44">${initials}</div>
          <div class="msg-col">
            <div class="msg-header">
              <span class="msg-author-label" style="color:${color}">${esc(agentId)}</span>
              <span class="msg-time-label">typingâ€¦</span>
            </div>
            <div class="typing-bubble"><span></span><span></span><span></span></div>
          </div>`;
        box.appendChild(row);
        scrollBottom(true);
      }
      clearTimeout(typingTimers[agentId]);
      typingTimers[agentId] = setTimeout(() => hideTyping(agentId), 8000);
    }

    function hideTyping(agentId) {
      const el = document.getElementById(`typing-${agentId}`);
      if (el) el.remove();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Compose
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function sendMessage() {
    return window.AcbChat.sendMessage({
      getActiveThreadId: () => activeThreadId,
      updateOnlinePresence,
      autoResize,
      api,
      setLastSeq: (next) => {
        lastSeq = typeof next === 'function' ? next(lastSeq) : next;
      },
      appendBubble,
      scrollBottom,
    });
    }

  function handleKey(e) {
    return window.AcbChat.handleKey(e, sendMessage);
  }

    function autoResize(el) {
      return window.AcbUtils.autoResize(el);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Agents
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function refreshAgents() {
    return window.AcbAgents.refreshAgents({
      api,
      hideAgentTooltip,
      setCurrentAgents: (agents) => {
        currentAgents = agents;
      },
      onlineAgentKeys,
      onlineAgentLabelsByKey,
      updateOnlinePresence,
    });
  }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Helper: Escape HTML
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function escapeHtml(t) {
          return window.AcbUtils.escapeHtml(t);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Agent Status Bar Update
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function updateStatusBar() {
          return window.AcbAgents.updateStatusBar({
            api,
            setCurrentAgents: (agents) => {
              currentAgents = agents;
            },
            getActiveThreadId: () => activeThreadId,
            getAgentState,
            getStateEmoji,
            getOfflineTime,
            isOfflineMoreThanHour,
            getCompressedOfflineChar,
            escapeHtml,
            bindAgentTooltipEvents,
          });
        }
        
        function getAgentState(agent) {
          return window.AcbAgentStatus.getAgentState(agent);
        }

        function getOfflineTime(agent) {
          return window.AcbAgentStatus.getOfflineTime(agent);
        }

        function isOfflineMoreThanHour(agent) {
          return window.AcbAgentStatus.isOfflineMoreThanHour(agent);
        }

        function getCompressedOfflineChar(offlineTimeStr) {
          return window.AcbAgentStatus.getCompressedOfflineChar(offlineTimeStr);
        }
        
        
        function getStateEmoji(state) {
          return window.AcbAgentStatus.getStateEmoji(state);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Sidebar tabs
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function switchTab(tab) {
          // Only threads tab is available now
          if (tab !== 'threads') return;
          // Control filter visibility
          const filterWrap = document.getElementById('thread-filter-wrap');
          if (filterWrap) {
            filterWrap.style.display = '';
          }
        }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Modal
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function openModal() {
      return window.AcbModals.openThreadModal();
    }

    function closeModal(e) {
      return window.AcbModals.closeThreadModal(e);
    }

  async function submitModal() {
    return window.AcbModals.submitThreadModal({ api, refreshThreads, selectThread });
  }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Extras: thread state & close (REST shims)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Extend the REST API with two extra POST endpoints that main.py may serve later.
    // If they 404, we silently ignore â€” the MCP tool path is the canonical way.

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Utilities
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function esc(s) {
      return window.AcbUtils.esc(s);
    }

      function scrollBottom(smooth = false) {
      const box = document.getElementById('messages');
      if (!box) return;

        // Use setTimeout to ensure DOM updates and layout are fully applied
        // before attempting to scroll to the bottom.
        setTimeout(() => {
        // Force synchronous layout so scrollHeight is accurate
        void box.offsetHeight;
        if (smooth) {
          console.log('Scrolling to bottom',{ top: box.scrollHeight, behavior: 'smooth' });
          box.scrollTo({ top: box.scrollHeight, behavior: 'smooth' });
        } else {
          box.scrollTop = box.scrollHeight;
        }
      }, 50);
    }

    function timeAgo(iso) {
      return window.AcbUtils.timeAgo(iso);
    }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Settings Settings
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function openSettingsModal() {
    return window.AcbModals.openSettingsModal(api);
  }

  function closeSettingsModal(e) {
    return window.AcbModals.closeSettingsModal(e);
  }

  async function submitSettings() {
    return window.AcbModals.submitSettings(api);
  }
</script>
</body>
</html>
