<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AgentChatBus Console</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: #0d1117; color: #c9d1d9;
    display: flex; height: 100vh; overflow: hidden;
  }
  /* â”€â”€ Sidebar â”€â”€ */
  #sidebar {
    width: 260px; background: #161b22; border-right: 1px solid #30363d;
    display: flex; flex-direction: column; flex-shrink: 0;
  }
  #sidebar h2 { padding: 16px; font-size: 14px; color: #8b949e; text-transform: uppercase; letter-spacing: .06em; }
  #thread-list { flex: 1; overflow-y: auto; }
  .thread-item {
    padding: 10px 16px; cursor: pointer; border-left: 3px solid transparent;
    transition: background .15s;
  }
  .thread-item:hover { background: #1f2937; }
  .thread-item.active { border-left-color: #58a6ff; background: #1f2937; }
  .thread-item .topic { font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .thread-item .status { font-size: 11px; color: #8b949e; margin-top: 2px; }
  .badge {
    display: inline-block; padding: 1px 6px; border-radius: 10px; font-size: 10px; font-weight: 600;
  }
  .badge-discuss   { background:#174291; color:#58a6ff; }
  .badge-implement { background:#1d3d1e; color:#3fb950; }
  .badge-review    { background:#3d2b00; color:#d29922; }
  .badge-done      { background:#1f2937; color:#8b949e; }
  .badge-closed    { background:#1f2937; color:#484f58; }
  #agents-panel { padding: 12px 16px; border-top: 1px solid #30363d; }
  #agents-panel h3 { font-size: 12px; color: #8b949e; margin-bottom: 8px; }
  .agent-row { display: flex; align-items: center; gap: 6px; font-size: 12px; margin-bottom: 4px; }
  .dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
  .dot-online { background: #3fb950; }
  .dot-offline { background: #484f58; }

  /* â”€â”€ Main area â”€â”€ */
  #main {
    flex: 1; display: flex; flex-direction: column; overflow: hidden;
  }
  #header {
    padding: 14px 20px; border-bottom: 1px solid #30363d;
    display: flex; align-items: center; justify-content: space-between;
  }
  #header h1 { font-size: 16px; font-weight: 600; }
  #header span { font-size: 12px; color: #8b949e; }
  #messages {
    flex: 1; overflow-y: auto; padding: 16px 20px;
    display: flex; flex-direction: column; gap: 12px;
  }
  .msg-bubble {
    max-width: 75%; padding: 10px 14px; border-radius: 10px; font-size: 13px; line-height: 1.5;
    word-break: break-word;
  }
  .msg-user      { background: #1f2937; align-self: flex-start; }
  .msg-assistant { background: #0d419d; align-self: flex-end; }
  .msg-system    { background: #2d1a00; align-self: center; font-style: italic; color: #d29922; font-size: 12px; }
  .msg-meta { font-size: 10px; color: #8b949e; margin-top: 4px; }
  #compose {
    padding: 12px 20px; border-top: 1px solid #30363d;
    display: flex; gap: 8px; align-items: flex-end;
  }
  #compose textarea {
    flex: 1; background: #161b22; border: 1px solid #30363d; border-radius: 8px;
    color: #c9d1d9; padding: 8px 12px; font-size: 13px; resize: none; min-height: 40px; max-height: 120px;
    font-family: inherit;
  }
  #compose textarea:focus { outline: none; border-color: #58a6ff; }
  button {
    background: #1f6feb; color: #fff; border: none; border-radius: 8px;
    padding: 8px 16px; font-size: 13px; cursor: pointer; white-space: nowrap;
    transition: background .15s;
  }
  button:hover { background: #388bfd; }
  button.secondary { background: #21262d; color: #c9d1d9; }
  button.secondary:hover { background: #30363d; }
  #empty-state {
    flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
    color: #484f58; gap: 8px;
  }
  #empty-state .icon { font-size: 40px; }
  #new-thread-btn { margin: 12px 16px; width: calc(100% - 32px); }
</style>
</head>
<body>

<div id="sidebar">
  <h2>ðŸšŒ AgentChatBus</h2>
  <button id="new-thread-btn" onclick="promptNewThread()">+ New Thread</button>
  <div id="thread-list"></div>
  <div id="agents-panel">
    <h3>Agents</h3>
    <div id="agent-list"></div>
  </div>
</div>

<div id="main">
  <div id="header">
    <h1 id="thread-title">Select a thread</h1>
    <span id="thread-status"></span>
  </div>
  <div id="messages">
    <div id="empty-state">
      <div class="icon">ðŸ’¬</div>
      <div>Select or create a thread to begin</div>
    </div>
  </div>
  <div id="compose" style="display:none">
    <textarea id="compose-input" rows="1" placeholder="Send a system message..." onkeydown="handleKey(event)"></textarea>
    <button onclick="sendSystemMessage()">Send</button>
  </div>
</div>

<script>
  let activeThreadId = null;
  let lastSeq = 0;
  let threads = [];

  // â”€â”€ Bootstrap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function init() {
    await refreshThreads();
    await refreshAgents();
    listenSSE();
    setInterval(refreshAgents, 15000);
  }

  // â”€â”€ API helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function api(path, opts={}) {
    const r = await fetch(path, { headers: {'Content-Type':'application/json'}, ...opts });
    return r.json();
  }

  // â”€â”€ Threads â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function refreshThreads() {
    threads = await api('/api/threads');
    const list = document.getElementById('thread-list');
    list.innerHTML = threads.map(t => `
      <div class="thread-item ${t.id === activeThreadId ? 'active' : ''}" onclick="selectThread('${t.id}','${escHtml(t.topic)}','${t.status}')">
        <div class="topic">${escHtml(t.topic)}</div>
        <div class="status"><span class="badge badge-${t.status}">${t.status}</span></div>
      </div>
    `).join('');
  }

  async function selectThread(id, topic, status) {
    activeThreadId = id; lastSeq = 0;
    document.getElementById('thread-title').textContent = topic;
    document.getElementById('thread-status').innerHTML = `<span class="badge badge-${status}">${status}</span>`;
    document.getElementById('messages').innerHTML = '';
    document.getElementById('empty-state') && document.getElementById('empty-state').remove();
    document.getElementById('compose').style.display = 'flex';
    await refreshThreads();
    await loadMessages();
  }

  async function loadMessages() {
    if (!activeThreadId) return;
    const msgs = await api(`/api/threads/${activeThreadId}/messages?after_seq=${lastSeq}&limit=200`);
    msgs.forEach(appendMessage);
    if (msgs.length) lastSeq = msgs[msgs.length-1].seq;
  }

  function appendMessage(m) {
    const box = document.getElementById('messages');
    const div = document.createElement('div');
    div.className = `msg-bubble msg-${m.role}`;
    div.innerHTML = `<div>${escHtml(m.content)}</div><div class="msg-meta">${m.author} Â· seq ${m.seq}</div>`;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
  }

  async function promptNewThread() {
    const topic = prompt('Thread topic:');
    if (!topic) return;
    // Call REST to create thread (via MCP tool is also fine, simplified here)
    const r = await api('/api/threads', { method: 'POST', body: JSON.stringify({topic}) });
    await refreshThreads();
  }

  // â”€â”€ Compose â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function sendSystemMessage() {
    const input = document.getElementById('compose-input');
    const content = input.value.trim();
    if (!content || !activeThreadId) return;
    input.value = '';
    await api(`/api/threads/${activeThreadId}/messages`, {
      method: 'POST',
      body: JSON.stringify({ author: 'human', role: 'system', content }),
    });
  }

  function handleKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendSystemMessage(); }
  }

  // â”€â”€ Agents â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function refreshAgents() {
    const agents = await api('/api/agents');
    document.getElementById('agent-list').innerHTML = agents.map(a => `
      <div class="agent-row">
        <div class="dot ${a.is_online ? 'dot-online' : 'dot-offline'}"></div>
        <span>${escHtml(a.name)}</span>
      </div>
    `).join('') || '<div style="color:#484f58;font-size:12px;">No agents registered</div>';
  }

  // â”€â”€ SSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function listenSSE() {
    const es = new EventSource('/events');
    es.onmessage = async (e) => {
      const ev = JSON.parse(e.data);
      if (ev.type === 'msg.new' && ev.payload.thread_id === activeThreadId) {
        await loadMessages();
      }
      if (ev.type === 'thread.new' || ev.type === 'thread.state' || ev.type === 'thread.closed') {
        await refreshThreads();
      }
      if (ev.type === 'agent.online' || ev.type === 'agent.offline') {
        await refreshAgents();
      }
    };
    es.onerror = () => setTimeout(listenSSE, 3000);
  }

  // â”€â”€ Util â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function escHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  init();
</script>
</body>
</html>
